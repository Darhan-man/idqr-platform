<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Панель QR-кодов</title>
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
  #qrCanvasContainer { position: relative; width: 220px; margin-bottom: 10px; cursor: move; }
  #qrCanvas { border: 1px solid #ccc; }
</style>
</head>
<body>
<div class="container">
    <form method="post" action="/generate_qr" id="qrForm">
        <h2>Создание нового QR-Кода</h2>
        <input type="text" name="title" id="titleInput" placeholder="Название" required>
        <textarea name="qrdata" id="dataInput" placeholder="Данные для кодирования" required></textarea>

        <!-- скрытое поле для Y позиции текста -->
        <input type="hidden" name="text_y" id="formTextY" value="10">

        <button type="submit">Генерировать</button>
    </form>

    <div id="qrCanvasContainer">
        <canvas id="qrCanvas"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('qrCanvas');
const ctx = canvas.getContext('2d');
const titleInput = document.getElementById('titleInput');
const dataInput = document.getElementById('dataInput');
const formTextY = document.getElementById('formTextY');

let textY = 10; // начальная позиция текста
let dragging = false;
let dragStartY = 0;

// рисуем QR и текст
async function drawQR() {
    const title = titleInput.value || '';
    const data = dataInput.value || '';
    const fontSize = 32;
    const textColor = "red";

    // Генерация QR
    const qrCanvas = document.createElement('canvas');
    await QRCode.toCanvas(qrCanvas, data, { width: 200, margin: 1 });
    const qrSize = qrCanvas.width;

    ctx.font = `bold ${fontSize}px sans-serif`;

    // измеряем текст
    const textWidth = ctx.measureText(title).width;
    const textHeight = fontSize;

    // размер холста
    canvas.width = Math.max(qrSize, textWidth) + 20;
    canvas.height = textHeight + 15 + qrSize + 20;

    // фон
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // текст
    ctx.fillStyle = textColor;
    ctx.textBaseline = 'top';
    ctx.fillText(title, (canvas.width - textWidth) / 2, textY);

    // QR
    const qrX = (canvas.width - qrSize) / 2;
    const qrY = textY + textHeight + 15;
    ctx.drawImage(qrCanvas, qrX, qrY);

    // сохраняем Y в форму
    formTextY.value = textY;
}

// обновляем превью при вводе
titleInput.addEventListener('input', drawQR);
dataInput.addEventListener('input', drawQR);
window.addEventListener('load', drawQR);

// перемещение текста мышкой
const container = document.getElementById('qrCanvasContainer');
container.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const y = e.clientY - rect.top;
    if (y >= textY && y <= textY + 32) { // попадание на текст
        dragging = true;
        dragStartY = y - textY;
    }
});
window.addEventListener('mousemove', e => {
    if (dragging) {
        const rect = canvas.getBoundingClientRect();
        textY = e.clientY - rect.top - dragStartY;
        if (textY < 0) textY = 0;
        drawQR();
    }
});
window.addEventListener('mouseup', () => dragging = false);
</script>
</body>
</html>
