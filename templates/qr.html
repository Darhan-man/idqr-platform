<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å QR-–∫–æ–¥–æ–≤</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="navbar">
        <h1>IDQR: –ü–∞–Ω–µ–ª—å QR-–ö–æ–¥–æ–≤</h1>
        <nav>
            <a href="/dashboard/qr" class="{{ 'active' if active == 'qr' else '' }}">üì¶ QR-–ö–æ–¥—ã</a>
            <a href="/dashboard/modules" class="{{ 'active' if active == 'modules' else '' }}">üß© –ú–æ–¥—É–ª–∏</a>
            <a href="/dashboard/users" class="{{ 'active' if active == 'users' else '' }}">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/dashboard/stats" class="{{ 'active' if active == 'stats' else '' }}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="/dashboard/settings" class="{{ 'active' if active == 'settings' else '' }}">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        </nav>
    </div>

    <div class="container">
        <form method="post" action="/generate_qr" class="qr-form" id="qrForm">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ QR-–ö–æ–¥–∞</h2>
            <input type="text" name="title" id="titleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
            <textarea name="qrdata" id="dataInput" placeholder="–î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è" required></textarea>
            <input type="hidden" name="text_y" id="textYInput" value="10">
            <div class="qr-preview">
                <canvas id="qrCanvas" width="250" height="300"></canvas>
            </div>
            <button type="submit">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>

        {% if qr_url %}
            <div class="qr-preview">
                <img src="{{ qr_url }}" alt="QR">
            </div>
        {% endif %}

        <div class="qr-list">
            <h2>–°–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–æ–≤</h2>
            {% if qr_list %}
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–§–∞–π–ª</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for qr in qr_list %}
                        <tr>
                            <td>{{ qr[1] }}</td>
                            <td>{{ qr[4] }}</td>
                            <td><a href="/static/qr/{{ qr[3] }}" target="_blank">–ü—Ä–æ—Å–º–æ—Ç—Ä</a></td>
                            <td>
                                <a href="/delete_qr/{{ qr[0] }}" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</a>
                                <a href="/static/qr/{{ qr[3] }}" download class="btn-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>QR-–∫–æ–¥—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>
            {% endif %}
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const canvas = document.getElementById("qrCanvas");
const ctx = canvas.getContext("2d");

const titleInput = document.getElementById("titleInput");
const dataInput = document.getElementById("dataInput");
const textYInput = document.getElementById("textYInput");

let textY = parseInt(textYInput.value);
let isDragging = false;

async function drawQR() {
    const title = titleInput.value || '';
    const data = dataInput.value || '';
    const FONT_SIZE = 32;
    const TEXT_COLOR = "red";
    const BETWEEN_MARGIN = 15;

    const qrCanvas = document.createElement('canvas');
    await QRCode.toCanvas(qrCanvas, data, { width: 200, margin: 1 });
    const qrSize = qrCanvas.width;

    canvas.width = qrSize + 20;
    canvas.height = textY + FONT_SIZE + BETWEEN_MARGIN + qrCanvas.height + 10;

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = TEXT_COLOR;
    ctx.font = `bold ${FONT_SIZE}px sans-serif`;
    const textWidth = ctx.measureText(title).width;
    ctx.fillText(title, (canvas.width - textWidth) / 2, textY + FONT_SIZE);

    const qrX = (canvas.width - qrCanvas.width) / 2;
    const qrY = textY + FONT_SIZE + BETWEEN_MARGIN;
    ctx.drawImage(qrCanvas, qrX, qrY);
}

titleInput.addEventListener('input', drawQR);
dataInput.addEventListener('input', drawQR);

canvas.addEventListener('mousedown', (e) => {
    const y = e.offsetY;
    if (y >= textY && y <= textY + 32) {
        isDragging = true;
    }
});
canvas.addEventListener('mousemove', (e) => {
    if (isDragging) {
        textY = e.offsetY - 16;
        if (textY < 0) textY = 0;
        textYInput.value = textY;
        drawQR();
    }
});
canvas.addEventListener('mouseup', () => isDragging = false);
canvas.addEventListener('mouseleave', () => isDragging = false);

drawQR();
</script>
</body>
</html>
