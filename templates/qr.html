<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>QR Preview с контролем цвета и текста</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  canvas { border: 1px solid #ccc; display: block; margin-top: 20px; }
  label { display: block; margin-top: 10px; }
</style>
</head>
<body>

<h2>Живое превью QR-кода</h2>

<label>Название QR:
  <input type="text" id="titleInput" value="Пример текста">
</label>

<label>Данные QR:
  <input type="text" id="dataInput" value="https://idqr-platform.onrender.com">
</label>

<label>Цвет текста:
  <input type="color" id="textColorInput" value="#ff0000">
</label>

<label>Цвет QR-кода:
  <input type="color" id="qrColorInput" value="#000000">
</label>

<label>Цвет фона:
  <input type="color" id="bgColorInput" value="#ffffff">
</label>

<label>Отступ сверху (px):
  <input type="number" id="topMarginInput" value="10" min="0">
</label>

<label>Максимальный размер шрифта (px):
  <input type="number" id="fontSizeInput" value="32" min="12">
</label>

<label>Ширина текста (% от QR):
  <input type="range" id="textWidthInput" value="90" min="30" max="100">
  <span id="textWidthVal">90%</span>
</label>

<button id="downloadBtn">Скачать PNG</button>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const titleInput = document.getElementById('titleInput');
const dataInput = document.getElementById('dataInput');
const textColorInput = document.getElementById('textColorInput');
const qrColorInput = document.getElementById('qrColorInput');
const bgColorInput = document.getElementById('bgColorInput');
const topMarginInput = document.getElementById('topMarginInput');
const fontSizeInput = document.getElementById('fontSizeInput');
const textWidthInput = document.getElementById('textWidthInput');
const textWidthVal = document.getElementById('textWidthVal');
const downloadBtn = document.getElementById('downloadBtn');

async function drawQR() {
    const title = titleInput.value || '';
    const data = dataInput.value || '';
    const textColor = textColorInput.value;
    const qrColor = qrColorInput.value;
    const bgColor = bgColorInput.value;
    const topMargin = parseInt(topMarginInput.value);
    let fontSize = parseInt(fontSizeInput.value);
    const minFontSize = 12;
    const textWidthPercent = parseInt(textWidthInput.value);
    textWidthVal.textContent = textWidthPercent + '%';

    // Генерация QR
    const qrCanvas = document.createElement('canvas');
    await QRCode.toCanvas(qrCanvas, data, { width: 200, margin: 1, color: { dark: qrColor, light: bgColor } });
    const qrSize = qrCanvas.width;

    const maxTextWidth = qrSize * textWidthPercent / 100;

    function splitText(text, fontSize) {
        ctx.font = `bold ${fontSize}px sans-serif`;
        const words = text.split(' ');
        const lines = [];
        let current = '';
        for (let word of words) {
            const testLine = current ? current + ' ' + word : word;
            if (ctx.measureText(testLine).width > maxTextWidth) {
                if (current) lines.push(current);
                current = word;
            } else {
                current = testLine;
            }
        }
        if (current) lines.push(current);
        return lines;
    }

    let lines = splitText(title, fontSize);

    // Автоматическая подгонка шрифта
    while (lines.some(line => ctx.measureText(line).width > maxTextWidth) && fontSize > minFontSize) {
        fontSize -= 1;
        lines = splitText(title, fontSize);
    }

    const lineHeight = fontSize + 4;
    const textHeight = lines.length * lineHeight;

    canvas.width = qrSize;
    canvas.height = qrSize + textHeight + topMargin + 5;

    // Фон
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Текст
    ctx.fillStyle = textColor;
    ctx.font = `bold ${fontSize}px sans-serif`;
    lines.forEach((line, i) => {
        const textWidth = ctx.measureText(line).width;
        ctx.fillText(line, (canvas.width - textWidth) / 2, topMargin + (i + 1) * lineHeight - 4);
    });

    // QR-код
    const qrY = textHeight + topMargin + 5;
    ctx.drawImage(qrCanvas, 0, qrY);
}

// Автообновление при изменении данных
[titleInput, dataInput, textColorInput, qrColorInput, bgColorInput, topMarginInput, fontSizeInput, textWidthInput].forEach(el => {
    el.addEventListener('input', drawQR);
});

// Скачать PNG
downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'qr.png';
    link.href = canvas.toDataURL();
    link.click();
});

// Первый рендер
drawQR();
</script>

</body>
</html>
