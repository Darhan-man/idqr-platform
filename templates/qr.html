
Ôªø<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å QR-–∫–æ–¥–æ–≤</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="navbar">
        <h1>IDQR: –ü–∞–Ω–µ–ª—å QR-–ö–æ–¥–æ–≤</h1>
        <nav>
            <a href="/dashboard/qr" class="{{ 'active' if active == 'qr' else '' }}">üì¶ QR-–ö–æ–¥—ã</a>
            <a href="/dashboard/modules" class="{{ 'active' if active == 'modules' else '' }}">üß© –ú–æ–¥—É–ª–∏</a>
            <a href="/dashboard/users" class="{{ 'active' if active == 'users' else '' }}">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/dashboard/stats" class="{{ 'active' if active == 'stats' else '' }}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="/dashboard/settings" class="{{ 'active' if active == 'settings' else '' }}">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            <a href="/dashboard/services" class="{{ 'active' if active == 'services' else '' }}">üõ†Ô∏è –£—Å–ª—É–≥–∏ –∏ –±—ã—Ç</a>
        </nav>
    </div>

    <div class="container">
        <form method="post" action="/generate_qr" class="qr-form">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ QR-–ö–æ–¥–∞</h2>
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
            <textarea name="qrdata" placeholder="–î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è" required></textarea>
            <button type="submit">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>

        {% if qr_url %}
            <div class="qr-preview">
                <img src="{{ qr_url }}" alt="QR">
            </div>
        {% endif %}

        <div class="qr-list">
            <h2>–°–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–æ–≤</h2>
            {% if qr_list %}
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–§–∞–π–ª</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for qr in qr_list %}
                        <tr>
                            <td>{{ qr[1] }}</td>
                            <td>{{ qr[4] }}</td>
                            <td><a href="/static/qr/{{ qr[3] }}" target="_blank">–ü—Ä–æ—Å–º–æ—Ç—Ä</a></td>
                            <td>
                                <a href="/delete_qr/{{ qr[0] }}" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</a>
                                <a href="/static/qr/{{ qr[3] }}" download class="btn-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>QR-–∫–æ–¥—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>

<h2>–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é QR-–∫–æ–¥–∞</h2>

<label>–ù–∞–∑–≤–∞–Ω–∏–µ QR:
  <input type="text" id="titleInput" value="–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞">
</label>

<label>–î–∞–Ω–Ω—ã–µ QR:
  <input type="text" id="dataInput" value="https://idqr-platform.onrender.com">
</label>

<label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:
  <input type="color" id="textColorInput" value="#ff0000">
</label>

<label>–¶–≤–µ—Ç QR-–∫–æ–¥–∞:
  <input type="color" id="qrColorInput" value="#000000">
</label>

<label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞:
  <input type="color" id="bgColorInput" value="#ffffff">
</label>

<label>–û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (px):
  <input type="number" id="topMarginInput" value="10" min="0">
</label>

<label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px):
  <input type="number" id="fontSizeInput" value="32" min="12">
</label>

<label>–®–∏—Ä–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ (% –æ—Ç QR):
  <input type="range" id="textWidthInput" value="90" min="30" max="100">
  <span id="textWidthVal">90%</span>
</label>

<button id="downloadBtn">–°–∫–∞—á–∞—Ç—å PNG</button>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const titleInput = document.getElementById('titleInput');
const dataInput = document.getElementById('dataInput');
const textColorInput = document.getElementById('textColorInput');
const qrColorInput = document.getElementById('qrColorInput');
const bgColorInput = document.getElementById('bgColorInput');
const topMarginInput = document.getElementById('topMarginInput');
const fontSizeInput = document.getElementById('fontSizeInput');
const textWidthInput = document.getElementById('textWidthInput');
const textWidthVal = document.getElementById('textWidthVal');
const downloadBtn = document.getElementById('downloadBtn');

async function drawQR() {
    const title = titleInput.value || '';
    const data = dataInput.value || '';
    const textColor = textColorInput.value;
    const qrColor = qrColorInput.value;
    const bgColor = bgColorInput.value;
    const topMargin = parseInt(topMarginInput.value);
    let fontSize = parseInt(fontSizeInput.value);
    const minFontSize = 12;
    const textWidthPercent = parseInt(textWidthInput.value);
    textWidthVal.textContent = textWidthPercent + '%';

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR
    const qrCanvas = document.createElement('canvas');
    await QRCode.toCanvas(qrCanvas, data, { width: 200, margin: 1, color: { dark: qrColor, light: bgColor } });
    const qrSize = qrCanvas.width;

    const maxTextWidth = qrSize * textWidthPercent / 100;

    function splitText(text, fontSize) {
        ctx.font = `bold ${fontSize}px sans-serif`;
        const words = text.split(' ');
        const lines = [];
        let current = '';
        for (let word of words) {
            const testLine = current ? current + ' ' + word : word;
            if (ctx.measureText(testLine).width > maxTextWidth) {
                if (current) lines.push(current);
                current = word;
            } else {
                current = testLine;
            }
        }
        if (current) lines.push(current);
        return lines;
    }

    let lines = splitText(title, fontSize);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ —à—Ä–∏—Ñ—Ç–∞
    while (lines.some(line => ctx.measureText(line).width > maxTextWidth) && fontSize > minFontSize) {
        fontSize -= 1;
        lines = splitText(title, fontSize);
    }

    const lineHeight = fontSize + 4;
    const textHeight = lines.length * lineHeight;

    canvas.width = qrSize;
    canvas.height = qrSize + textHeight + topMargin + 5;

    // –§–æ–Ω
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // –¢–µ–∫—Å—Ç
    ctx.fillStyle = textColor;
    ctx.font = `bold ${fontSize}px sans-serif`;
    lines.forEach((line, i) => {
        const textWidth = ctx.measureText(line).width;
        ctx.fillText(line, (canvas.width - textWidth) / 2, topMargin + (i + 1) * lineHeight - 4);
    });

    // QR-–∫–æ–¥
    const qrY = textHeight + topMargin + 5;
    ctx.drawImage(qrCanvas, 0, qrY);
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
[titleInput, dataInput, textColorInput, qrColorInput, bgColorInput, topMarginInput, fontSizeInput, textWidthInput].forEach(el => {
    el.addEventListener('input', drawQR);
});

// –°–∫–∞—á–∞—Ç—å PNG
downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'qr.png';
    link.href = canvas.toDataURL();
    link.click();
});

// –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
drawQR();
</script>

</body>
</html>
